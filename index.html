<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Público - CMM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --cor-primaria: #0d6efd; /* Azul primário */
            --cor-secundaria: #6c757d; /* Cinza secundário */
            --fundo: #f8f9fa; /* Fundo cinza claro */
            --borda: #dee2e6;
            --texto: #212529;
            --branco: #fff;
            --sombra: 0 4px 8px rgba(0, 0, 0, 0.05);
            --marrom-logo: #5D493C;
            --vermelho-inativo: #dc3545;
            --level-1-color: #fd7e14;
            --level-2-color: #ffc107;
            --level-3-color: #a3d900;
            --level-4-color: #198754;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--fundo);
            color: var(--texto);
        }
        
        #dashboard-view { display: flex; flex-direction: column; height: 100vh; }
        
        #app-header { display: flex; justify-content: center; align-items: center; padding: 15px 30px; background-color: var(--branco); border-bottom: 1px solid var(--borda); flex-shrink: 0; position: relative; }
        #header-buttons { position: absolute; left: 30px; display: flex; align-items: center; gap: 10px; }
        #app-header h1 { font-size: 2em; color: var(--marrom-logo); margin: 0; text-align: center;}
        #app-header-logo { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); }
        #app-header-logo img { height: 50px; max-width: 250px; display: block; }
        
        #app-container { display: flex; flex-grow: 1; overflow: hidden; }
        #sidebar { width: 300px; background-color: var(--branco); border-right: 1px solid var(--borda); padding: 20px; overflow-y: auto; flex-shrink: 0; }
        #sidebar-title { color: var(--cor-primaria); text-align: center; margin-top: 0; margin-bottom: 15px; }
        #lista-entidades { list-style: none; padding: 0; margin: 0; }
        .nav-item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; position: relative; }
        .nav-item:hover { background-color: #e9ecef; }
        .nav-item.active { background-color: var(--cor-primaria); color: var(--branco); font-weight: 600; }
        .entidade-foto-container { position: relative; flex-shrink: 0; }
        .nav-item img { width: 68px; height: 68px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 3px solid #d3d3d3; }
        .inactivity-indicator { display: none; position: absolute; top: 0; right: 15px; width: 18px; height: 18px; background-color: var(--vermelho-inativo); border: 2px solid var(--branco); border-radius: 50%; }
        .nav-item.inactive .inactivity-indicator { display: block; }
        
        #home-button { padding: 0; justify-content: center; }
        #home-button-icon { width: 223px; height: 50px; border-radius: 8px; object-fit: contain; border: 2px solid transparent; background: transparent; margin-right: 0; padding: 5px; box-sizing: border-box; }
        #home-button.active { background-color: transparent; }
        #home-button.active #home-button-icon { filter: none; border: 2px solid var(--marrom-logo); }

        #vereadores-button,
        #comissoes-button,
        #institucional-button { 
            justify-content: center; 
            font-weight: 600; 
            font-size: 1.1em; 
            border: 1px solid var(--borda); 
            background-color: var(--fundo); 
            color: var(--texto); 
        }
        #vereadores-button { margin-top: 15px; }

        #vereadores-button.active,
        #comissoes-button.active,
        #institucional-button.active { 
            background-color: var(--cor-primaria); 
            color: var(--branco); 
            border-color: var(--cor-primaria); 
        }

        #search-bar { width: 100%; padding: 10px; border: 1px solid var(--borda); border-radius: 6px; font-size: 1em; box-sizing: border-box; margin-top: 15px; }

        #main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .header-controles { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px; background-color: rgba(248, 249, 250, 0.9); padding: 15px; border-radius: 8px; box-shadow: var(--sombra); position: sticky; top: -30px; z-index: 10; }
        .card { background-color: var(--branco); border-radius: 8px; padding: 25px; box-shadow: var(--sombra); margin-bottom: 25px; }
        #ranking-card h2, .chart-card h2 { text-align: center; margin-top: 0; }
        .pizza-total-container { text-align: center; font-size: 1.2em; margin-top: 15px; }
        .pizza-total-container strong { font-size: 1.5em; color: var(--cor-primaria); }

        .home-charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .chart-card { height: 450px; }

        .ranking-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 25px 20px; justify-items: center; }
        .podium-item { position: relative; cursor: pointer; }
        .podium-item img { width: 70px; height: 70px; border-radius: 50%; border: 4px solid #d3d3d3; transition: transform 0.2s ease-in-out; object-fit: cover; }
        .podium-item:hover img { transform: scale(1.1); }
        .podium-rank-badge { position: absolute; bottom: 2px; right: 2px; background-color: rgba(0, 0, 0, 0.7); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-size: 0.8em; font-weight: bold; }
        .custom-tooltip { visibility: hidden; opacity: 0; position: absolute; top: 105%; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; text-align: left; padding: 10px; border-radius: 6px; z-index: 1; font-size: 1em; white-space: nowrap; transition: opacity 0.3s; }
        .podium-item:hover .custom-tooltip { visibility: visible; opacity: 1; }
        
        .nav-item.level-1 img, .podium-item.level-1 img, #info-entidade.level-1 img { border-color: var(--level-1-color); }
        .nav-item.level-2 img, .podium-item.level-2 img, #info-entidade.level-2 img { border-color: var(--level-2-color); }
        .nav-item.level-3 img, .podium-item.level-3 img, #info-entidade.level-3 img { border-color: var(--level-3-color); }
        .nav-item.level-4 img, .podium-item.level-4 img, #info-entidade.level-4 img { border-color: var(--level-4-color); }
        
        .info-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: center; }
        #info-entidade { display: flex; align-items: center; }
        
        #info-entidade img {
            width: 120px;
            height: 160px;
            border-radius: 8px;
            margin-right: 25px;
            border-width: 4px;
            border-style: solid;
            border-color: #d3d3d3;
            object-fit: cover;
        }
        
        #info-entidade h1 { margin: 0; font-size: 2.2em; }
        
        #totais-card { display: flex; justify-content: space-around; text-align: center; }
        .total-item h3 { margin: 0 0 10px 0; color: var(--cor-secundaria); font-size: 1.1em; }
        .total-valor { font-size: 2.5em; font-weight: bold; color: var(--cor-primaria); }
        
        .individual-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: start;
        }
        .individual-content-grid > .card {
            height: 420px;
            display: flex;
            flex-direction: column;
        }
        #calendar-container, #graficoAnual {
            flex-grow: 1;
            min-height: 0;
        }

        #calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; color: var(--cor-secundaria); margin-bottom: 10px; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex-grow: 1; }
        .calendar-day { 
            padding: 5px; 
            min-height: 50px;
            background-color: var(--branco); 
            border: 1px solid var(--borda); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            font-size: 0.75em; 
            position: relative; 
        }
        .calendar-day:hover { background-color: #e9ecef; }
        .calendar-day.weekend .day-number { color: #adb5bd; }
        .day-number { font-weight: bold; }
        .day-value { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--cor-primaria); 
            text-align: center; 
        }
        .note-indicator { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background-color: var(--cor-primaria); border-radius: 50%; cursor: help; }
        .link-indicators-container {
            position: absolute;
            top: 5px;
            left: 5px;
            display: flex;
            gap: 4px;
        }
        .link-indicator { 
            color: var(--cor-secundaria); 
            text-decoration: none; 
            font-size: 1.1em;
            cursor: pointer;
        }

        #goal-container { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--borda); }
        #goal-progress-container { background-color: var(--borda); border-radius: 10px; overflow: hidden; }
        #goal-progress-bar { height: 20px; background-color: var(--level-4-color); width: 0%; transition: width 0.5s; }
        #goal-progress-text { text-align: center; margin-top: 5px; font-weight: 500; }
    </style>
</head>
<body>
    <div id="dashboard-view">
        <header id="app-header">
            <div id="header-buttons">
            </div>
            <h1>CÂMARA MUNICIPAL DE MARABÁ</h1>
            <a id="app-header-logo" href="#" target="_blank" rel="noopener noreferrer">
                <img src="./Logo CMM Horizontal.png" alt="Logo Câmara Municipal de Marabá">
            </a>
        </header>

        <div id="app-container">
            <aside id="sidebar">
                <h2 id="sidebar-title">Visão Geral</h2>
                <div id="sidebar-nav-buttons">
                    <div id="home-button" class="nav-item">
                        <img src="./Logo CMM Horizontal.png" id="home-button-icon" alt="Página Inicial">
                    </div>
                    <div id="vereadores-button" class="nav-item">
                         <span>Vereadores</span>
                    </div>
                    <div id="comissoes-button" class="nav-item">
                        <span>Comissões</span>
                    </div>
                    <div id="institucional-button" class="nav-item">
                        <span>Institucional</span>
                    </div>
                </div>
                <div id="sidebar-list-container">
                    <input type="search" id="search-bar" placeholder="Pesquisar...">
                    <ul id="lista-entidades"></ul>
                </div>
            </aside>

            <main id="main-content">
                <div class="header-controles">
                    <label for="seletor-mes">Mês:</label>
                    <select id="seletor-mes"></select>
                    <label for="seletor-ano">Ano:</label>
                    <select id="seletor-ano"></select>
                </div>
                
                <div id="home-view">
                    <div id="ranking-card" class="card">
                        <h2>🏆 Ranking do Mês</h2>
                        <div class="ranking-container" id="ranking-container"></div>
                    </div>
        
                    <div class="home-charts-container">
                        <div class="card chart-card" id="pizza-card-container">
                            <h2 id="titulo-grafico-geral">Matéria Geral do Mês</h2>
                            <canvas id="graficoGeralPizza"></canvas>
                            <div class="pizza-total-container">
                                <p id="pizza-total">Total de Matérias: <strong>0</strong></p>
                            </div>
                             <div id="goal-container">
                                  <div id="goal-progress-container">
                                       <div id="goal-progress-bar"></div>
                                  </div>
                                  <p id="goal-progress-text">0 / 0 (0%)</p>
                             </div>
                        </div>
                        <div class="card chart-card">
                            <h2>Desempenho Geral Anual</h2>
                            <canvas id="graficoAnualGeral"></canvas>
                        </div>
                    </div>
                </div>

                <div id="individual-view" style="display: none;">
                    <div class="info-container">
                        <div class="card" id="info-entidade">
                            <img id="entidade-foto" src="" alt="Foto">
                            <div class="info-details">
                                <h1 id="entidade-nome"></h1>
                            </div>
                        </div>
                        <div class="card" id="totais-card">
                            <div class="total-item">
                                <h3>Total no Mês</h3>
                                <p class="total-valor" id="total-mes">0</p>
                            </div>
                            <div class="total-item">
                                <h3>Total no Ano</h3>
                                <p class="total-valor" id="total-ano">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="individual-content-grid">
                        <div class="card">
                            <h2>Lançamento de Matéria Diária</h2>
                            <div id="calendar-container">
                                <div id="calendar-weekdays">
                                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                                </div>
                                <div id="calendar-grid"></div>
                            </div>
                        </div>
            
                        <div class="card">
                            <h2>Desempenho Anual (por Mês)</h2>
                            <canvas id="graficoAnual"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script type="module">
// ===================================================================================
// IMPORTAÇÕES DO FIREBASE E CONFIGURAÇÕES
// ===================================================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBOgVuFwTQgTT8UuRQL-SAFvy_SfFv5Ge0",
    authDomain: "controle-de-materias-a8112.firebaseapp.com",
    projectId: "controle-de-materias-a8112",
    storageBucket: "controle-de-materias-a8112.firebasestorage.app",
    messagingSenderId: "272892661767",
    appId: "1:272892661767:web:26d852120fa614a1b41aa2"
};

// ===================================================================================
// PASSO 1: CONFIGURE OS LINKS DA CÂMARA AQUI
// ===================================================================================
const CMM_LINKS = {
    site: "https://maraba.pa.leg.br/",
    instagram: "https://www.instagram.com/camarademaraba",
    facebook: "https://www.facebook.com/camarademaraba"
};

// ===================================================================================
// PASSO 2: CONFIGURE AS ENTIDADES (VEREADORES, COMISSÕES E INSTITUCIONAL)
// ===================================================================================
const VEREADORES = [
    { id: 'aerton_lima_da_cruz', nome: 'Aerton Lima da Cruz', foto: './aerton.png' },
    { id: 'antonio_marcio_farias_goncalves', nome: 'Antonio Márcio Farias Gonçalves', foto: './marcio.jpg' },
    { id: 'claudean_pereira_guimaraes', nome: 'Claudean Pereira Guimarães', foto: './dean.jpg' },
    { id: 'deodato_do_espirito_santo', nome: 'Deodato do Espirito Santo', foto: './dato.jpg' },
    { id: 'fernando_henrique_pereira_da_silva', nome: 'Fernando Henrique Pereira da Silva', foto: './fernando.jpg' },
    { id: 'ilker_moraes_ferreira', nome: 'Ilker Moraes Ferreira', foto: './ilker.jpg' },
    { id: 'jimmyson_mesquita_pacheco', nome: 'Jimmyson Mesquita Pacheco', foto: './pacheco.jpg' },
    { id: 'jocenilson_silva_souza', nome: 'Jocenilson Silva Souza', foto: './jocenilson.jpg' },
    { id: 'maiana_clara_rodrigues_stringari', nome: 'Maiana Clara Rodrigues Stringari', foto: './maiana.jpg' },
    { id: 'marcelo_alves_dos_santos', nome: 'Marcelo Alves dos Santos', foto: './marcelo.jpg' },
    { id: 'marcos_almeida_sousa_de_andrade', nome: 'Marcos Almeida Sousa de Andrade', foto: './marcos.jpg' },
    { id: 'maria_cristina_coimbra_mutran', nome: 'Maria Cristina Coimbra Mutran', foto: './cristina.jpg' },
    { id: 'miterran_lopes_feitosa', nome: 'Miterran Lopes Feitosa', foto: './miterran.jpg' },
    { id: 'orlando_da_silva_elias', nome: 'Orlando da Silva Elias', foto: './orlando.jpg' },
    { id: 'pedro_correa_lima', nome: 'Pedro Corrêa Lima', foto: './pedro.jpg' },
    { id: 'priscila_duarte_veloso_da_silva', nome: 'Priscila Duarte Veloso da Silva', foto: './priscila.jpg' },
    { id: 'rodrigo_lima_da_silva', nome: 'Rodrigo Lima da Silva', foto: './rodrigo.jpg' },
    { id: 'ronaldo_alves_de_araujo', nome: 'Ronaldo Alves de Araújo', foto: './ronaldo.jpg' },
    { id: 'ronisteu_da_silva_araujo', nome: 'Ronisteu da Silva Araújo', foto: './ronisteu.jpg' },
    { id: 'ubirajara_nazareno_sompre', nome: 'Ubirajara Nazareno Sompré', foto: './ubirajara.jpg' },
    { id: 'vanda_regia_americo_gomes', nome: 'Vanda Régia Américo Gomes', foto: './vanda.jpg' }
];

const COMISSOES = [
    { id: 'comissao_justica_legislacao_redacao', nome: 'Comissão de Justiça, Legislação e Redação', foto: './Comissão  Justiça.png' },
    { id: 'comissao_financas_orcamento', nome: 'Comissão de Finanças e Orçamento', foto: './Comissão  Finanças e Orçamento_.png' },
    { id: 'comissao_desenvolvimento_urbano', nome: 'Comissão de Desenvolvimento Urbano, Obras, Serviços Públicos e Transportes', foto: './Desenvolvimento Urbano.png' },
    { id: 'comissao_administracao_saude', nome: 'Comissão de Administração, Saúde, Serviços e Segurança Pública e Seguridade Social', foto: './Administração.png' },
    { id: 'comissao_educacao_cultura_desporto', nome: 'Comissão de Educação, Cultura e Desporto', foto: './Comissão de Educação.png' },
    { id: 'comissao_direitos_humanos', nome: 'Comissão de Direitos Humanos, Defesa do Consumidor, da Infância e Juventude, da Mulher e do Idoso', foto: './Direitos Humanos.png' },
    { id: 'comissao_mineracao_energia', nome: 'Comissão de Mineração, Energia, Meio Ambiente, Trabalho, Indústria, Comércio e Economia', foto: './Comissão de Mineração.png' }
];

const INSTITUCIONAL = [
    { id: 'institucional_cmm', nome: 'Institucional CMM', foto: './Câmara Municipal de Marabá .jpg' }
];

// ===================================================================================
// LÓGICA DO DASHBOARD
// ===================================================================================
Chart.register(ChartDataLabels);

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Elementos da UI
const seletorMes = document.getElementById('seletor-mes');
const seletorAno = document.getElementById('seletor-ano');
const listaEntidadesEl = document.getElementById('lista-entidades');
const entidadeNomeEl = document.getElementById('entidade-nome');
const entidadeFotoEl = document.getElementById('entidade-foto');
const homeView = document.getElementById('home-view');
const individualView = document.getElementById('individual-view');
const homeButton = document.getElementById('home-button');
const vereadoresButton = document.getElementById('vereadores-button');
const comissoesButton = document.getElementById('comissoes-button');
const institucionalButton = document.getElementById('institucional-button');
const searchBar = document.getElementById('search-bar');
const sidebarTitleEl = document.getElementById('sidebar-title');
const sidebarListContainer = document.getElementById('sidebar-list-container');

// Estado da Aplicação
let dadosProducao = {};
let metaMensal = 0;
let activeView = 'vereadores';
let entidadeAtivaId = null; 
let isSidebarListVisible = false;
let chartGeralInstance, chartAnualInstance, chartAnualGeralInstance;
const MESES = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];


function isUrl(text) {
    if (typeof text !== 'string') return false;
    const urlRegex = /^(https?:\/\/)/i;
    return urlRegex.test(text.trim());
}

function extractUrls(text) {
    if (typeof text !== 'string') return [];
    const words = text.split(/\s+/);
    return words.filter(word => isUrl(word));
}

function getProductionLevel(totalMensal) {
    if (totalMensal === 0) return 0;
    if (totalMensal <= 2) return 1;
    if (totalMensal <= 4) return 2;
    if (totalMensal <= 5) return 3;
    if (totalMensal >= 6) return 4;
    return 0;
}

function calcularTotais(ano, mes, listaDeEntidades) {
    let anoAnterior = ano;
    let mesAnterior = mes - 1;
    if (mesAnterior < 0) { mesAnterior = 11; anoAnterior = ano - 1; }

    return listaDeEntidades.map(entidade => {
        let totalMensal = 0, totalAnual = 0, totalMesAnterior = 0;
        const diasNoMes = new Date(ano, mes + 1, 0).getDate();
        for (let dia = 1; dia <= diasNoMes; dia++) {
            const chave = `${entidade.id}_${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            if (dadosProducao[chave]) totalMensal += (dadosProducao[chave].quantidade || 0);
        }
        for (const chave in dadosProducao) {
            if (chave.startsWith(`${entidade.id}_${ano}`)) totalAnual += (dadosProducao[chave].quantidade || 0);
        }
        const diasNoMesAnterior = new Date(anoAnterior, mesAnterior + 1, 0).getDate();
        for (let dia = 1; dia <= diasNoMesAnterior; dia++) {
            const chave = `${entidade.id}_${anoAnterior}-${String(mesAnterior + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            if (dadosProducao[chave]) totalMesAnterior += (dadosProducao[chave].quantidade || 0);
        }
        const level = getProductionLevel(totalMensal);
        return { ...entidade, totalMensal, totalAnual, totalMesAnterior, level };
    });
}

function escutarMudancasNosDados() {
    onSnapshot(collection(db, "materia"), (snapshot) => {
        dadosProducao = {};
        snapshot.forEach(doc => { dadosProducao[doc.id] = doc.data(); });
        renderizarViews();
    });
}

async function escutarMetaMensal() {
    const ano = seletorAno.value;
    const mes = String(parseInt(seletorMes.value) + 1).padStart(2, '0');
    const metaDocRef = doc(db, "metas", `${ano}-${mes}`);
    const docSnap = await getDoc(metaDocRef);
    metaMensal = docSnap.exists() ? docSnap.data().valor : 0;
    renderizarViews();
}

function popularSeletores() {
    if(seletorMes.options.length > 1) return;
    MESES.forEach((mes, index) => seletorMes.add(new Option(mes, index)));
    seletorMes.value = new Date().getMonth();
    for (let i = 2025; i <= 2034; i++) seletorAno.add(new Option(i, i));
    seletorAno.value = 2025;
}

function applySearchFilter() {
    const searchTerm = searchBar.value.toLowerCase();
    document.querySelectorAll('.entidade-item').forEach(item => {
        const itemName = item.querySelector('span').textContent.toLowerCase();
        item.style.display = itemName.includes(searchTerm) ? 'flex' : 'none';
    });
}

function popularListaSidebar(listaOrdenada) {
    listaEntidadesEl.innerHTML = '';
    listaOrdenada.forEach(entidade => {
        const li = document.createElement('li');
        li.className = 'nav-item entidade-item';
        
        if(entidade.level === 0) li.classList.add('inactive');
        else li.classList.add(`level-${entidade.level}`);
        
        li.dataset.id = entidade.id;
        li.innerHTML = `<div class="entidade-foto-container"><img src="${entidade.foto}" alt="${entidade.nome}"><div class="inactivity-indicator"></div></div><span>${entidade.nome}</span>`;
        if (entidade.id === entidadeAtivaId) li.classList.add('active');
        li.addEventListener('click', () => { 
            entidadeAtivaId = entidade.id; 
            renderizarViews(); 
        });
        listaEntidadesEl.appendChild(li);
    });
    applySearchFilter();
}

function renderizarCalendario() {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    const ano = parseInt(seletorAno.value);
    const mes = parseInt(seletorMes.value);
    const primeiroDia = new Date(ano, mes, 1).getDay();
    const diasNoMes = new Date(ano, mes + 1, 0).getDate();

    for (let i = 0; i < primeiroDia; i++) grid.appendChild(document.createElement('div'));

    for (let dia = 1; dia <= diasNoMes; dia++) {
        const dataISO = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        
        const chave = `${entidadeAtivaId}_${dataISO}`;
        const dadosDoDia = dadosProducao[chave];
        const valorSalvo = dadosDoDia?.quantidade || 0;
        const temObservacao = dadosDoDia?.observacao;
        const urls = extractUrls(temObservacao);

        let content = `<span class="day-number">${dia}</span>`;
        
        if (urls.length > 0) {
            const linksHTML = urls.map(url => 
                `<a href="${url}" target="_blank" class="link-indicator" title="${url}">🔗</a>`
            ).join('');
            content += `<div class="link-indicators-container" title="${temObservacao}">${linksHTML}</div>`;
        } else if (temObservacao) {
            content += `<div class="note-indicator" title="${temObservacao}"></div>`;
        }
        
        content += `<span class="day-value">${valorSalvo > 0 ? valorSalvo : ''}</span>`;
        dayCell.innerHTML = content;
        
        if (new Date(ano, mes, dia).getDay() % 6 === 0) dayCell.classList.add('weekend');
        grid.appendChild(dayCell);
    }
}

function renderizarRanking(totais) {
    const container = document.getElementById('ranking-container');
    container.innerHTML = '';
    const ranking = [...totais].sort((a, b) => b.totalMensal - a.totalMensal);
    
    ranking.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'podium-item';
        if(item.level > 0) div.classList.add(`level-${item.level}`);
        div.innerHTML = `
            <img src="${item.foto}" alt="${item.nome}">
            <span class="podium-rank-badge">${index + 1}.</span>
            <span class="custom-tooltip">${item.nome} | Atual: ${item.totalMensal} | Anterior: ${item.totalMesAnterior}</span>
        `;
        div.addEventListener('click', () => {
            isSidebarListVisible = true;
            entidadeAtivaId = item.id;
            renderizarViews();
        });
        container.appendChild(div);
    });
}

function renderizarProgressoMeta(totalGeral) {
    const progressBar = document.getElementById('goal-progress-bar');
    const progressText = document.getElementById('goal-progress-text');
    if(metaMensal > 0) {
        const percentual = Math.min((totalGeral / metaMensal) * 100, 100);
        progressBar.style.width = `${percentual}%`;
        progressText.textContent = `${totalGeral} / ${metaMensal} (${percentual.toFixed(0)}%)`;
    } else {
        progressBar.style.width = '0%';
        progressText.textContent = `${totalGeral} / 0 (0%)`;
    }
}

function renderizarGraficoGeralPizza(totais) {
    const ano = parseInt(seletorAno.value), mes = parseInt(seletorMes.value);
    document.getElementById('titulo-grafico-geral').textContent = `Matéria Geral em ${MESES[mes]} de ${ano}`;
    const produtivos = totais.filter(c => c.totalMensal > 0);
    const labels = produtivos.map(c => c.nome);
    const data = produtivos.map(c => c.totalMensal);
    const totalGeral = totais.reduce((sum, value) => sum + value.totalMensal, 0);
    document.querySelector("#pizza-total strong").textContent = totalGeral;
    renderizarProgressoMeta(totalGeral);
    const ctx = document.getElementById('graficoGeralPizza').getContext('2d');
    if (chartGeralInstance) chartGeralInstance.destroy();
    const bgColors = ['#0d6efd', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0', '#adb5bd', '#6c757d', '#343a40', '#007bff', '#6610f2', '#e83e8c', '#c82333', '#e0a800', '#218838', '#17a2b8', '#5a6268', '#23272b'].slice(0, labels.length);
    chartGeralInstance = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: bgColors, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, datalabels: { formatter: (v) => v, color: '#fff', font: { weight: 'bold', size: 14 } } } } });
}

function renderizarGraficoAnualGeral(listaDeEntidades) {
    const ano = parseInt(seletorAno.value);
    const data = [];
    const barColors = [];
    const topProducerNames = [];

    const colorMap = new Map();
    const predefinedColors = ['#0d6efd', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0', '#FF5733', '#C70039', '#900C3F', '#581845', '#4A235A', '#154360', '#117864', '#196F3D', '#7D6608', '#7E5109', '#78281F', '#4A235A'];
    listaDeEntidades.forEach((ent, index) => {
        colorMap.set(ent.id, predefinedColors[index % predefinedColors.length]);
    });
    const defaultColor = 'rgba(108, 117, 125, 0.7)';

    for (let mes = 0; mes < 12; mes++) {
        let totalMesGeral = 0;
        let topProducer = { id: null, nome: 'N/A', total: 0 };
        let isTie = false;

        listaDeEntidades.forEach(ent => {
            let totalEntidadeMes = 0;
            const diasNoMes = new Date(ano, mes + 1, 0).getDate();
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const chave = `${ent.id}_${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                if (dadosProducao[chave]) {
                    totalEntidadeMes += (dadosProducao[chave].quantidade || 0);
                }
            }
            
            totalMesGeral += totalEntidadeMes;

            if (totalEntidadeMes > topProducer.total) {
                topProducer = { id: ent.id, nome: ent.nome, total: totalEntidadeMes };
                isTie = false;
            } else if (totalEntidadeMes === topProducer.total && topProducer.total > 0) {
                isTie = true;
                topProducer.nome = 'Empate';
            }
        });
        
        data.push(totalMesGeral);
        topProducerNames.push(topProducer.nome);

        if (topProducer.id && !isTie) {
            barColors.push(colorMap.get(topProducer.id));
        } else {
            barColors.push(defaultColor);
        }
    }
    const ctx = document.getElementById('graficoAnualGeral').getContext('2d');
    if (chartAnualGeralInstance) chartAnualGeralInstance.destroy();
    chartAnualGeralInstance = new Chart(ctx, { 
        type: 'bar', 
        data: { 
            labels: MESES, 
            datasets: [{ 
                label: `Total de Matérias em ${ano}`, 
                data, 
                backgroundColor: barColors 
            }] 
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: false 
                }, 
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y;
                            }
                            return label;
                        },
                        afterLabel: function(context) {
                            const topProducer = topProducerNames[context.dataIndex];
                            if (topProducer !== 'N/A') {
                                return `Destaque: ${topProducer}`;
                            }
                            return '';
                        }
                    }
                },
                datalabels: { 
                    anchor: 'end', 
                    align: 'top', 
                    formatter: (value) => value > 0 ? value : '', 
                    color: '#333',
                    font: {
                        weight: 'bold'
                    }
                } 
            } 
        } 
    });
}


function renderizarCardTotais(dadosEntidade) {
    document.getElementById('total-mes').textContent = dadosEntidade.totalMensal;
    document.getElementById('total-ano').textContent = dadosEntidade.totalAnual;
}

function renderizarGraficoAnual(dadosEntidade) {
    const ano = parseInt(seletorAno.value), data = [];
    for (let mes = 0; mes < 12; mes++) {
        let totalMes = 0;
        for (const chave in dadosProducao) {
            if (chave.startsWith(`${dadosEntidade.id}_${ano}-${String(mes + 1).padStart(2, '0')}`)) {
                totalMes += (dadosProducao[chave].quantidade || 0);
            }
        }
        data.push(totalMes);
    }
    const ctx = document.getElementById('graficoAnual').getContext('2d');
    if (chartAnualInstance) chartAnualInstance.destroy();
    chartAnualInstance = new Chart(ctx, { type: 'bar', data: { labels: MESES, datasets: [{ label: `Total de Matérias em ${ano}`, data, backgroundColor: 'rgba(25, 135, 84, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (v) => v > 0 ? v : '', color: '#333' } } } });
}

function renderizarViews() {
    const ano = parseInt(seletorAno.value);
    const mes = parseInt(seletorMes.value);
    
    sidebarListContainer.style.display = isSidebarListVisible ? 'block' : 'none';

    homeButton.classList.remove('active');
    vereadoresButton.classList.remove('active');
    comissoesButton.classList.remove('active');
    institucionalButton.classList.remove('active');
    
    if (!isSidebarListVisible && activeView !== 'institucional') {
        homeButton.classList.add('active');
        sidebarTitleEl.textContent = 'Visão Geral';
    } else if (activeView === 'vereadores') {
        vereadoresButton.classList.add('active');
    } else if (activeView === 'comissoes') {
        comissoesButton.classList.add('active');
    } else if (activeView === 'institucional') {
        institucionalButton.classList.add('active');
    }

    homeView.style.display = 'none';
    individualView.style.display = 'none';
    let totais;

    switch (activeView) {
        case 'vereadores':
            if (isSidebarListVisible) sidebarTitleEl.textContent = 'Vereadores';
            searchBar.placeholder = 'Pesquisar vereador...';
            totais = calcularTotais(ano, mes, VEREADORES);
            
            totais.sort((a, b) => a.totalMensal - b.totalMensal);
            popularListaSidebar(totais);

            if (entidadeAtivaId) {
                renderizarIndividualView(totais.find(c => c.id === entidadeAtivaId));
            } else {
                renderizarHomeView(totais, VEREADORES);
            }
            break;

        case 'comissoes':
            if (isSidebarListVisible) sidebarTitleEl.textContent = 'Comissões';
            searchBar.placeholder = 'Pesquisar comissão...';
            totais = calcularTotais(ano, mes, COMISSOES);
            
            totais.sort((a, b) => a.totalMensal - b.totalMensal);
            popularListaSidebar(totais);

            if (entidadeAtivaId) {
                renderizarIndividualView(totais.find(c => c.id === entidadeAtivaId));
            } else {
                renderizarHomeView(totais, COMISSOES);
            }
            break;

        case 'institucional':
            sidebarTitleEl.textContent = 'Institucional';
            totais = calcularTotais(ano, mes, INSTITUCIONAL);
            entidadeAtivaId = INSTITUCIONAL[0].id;
            renderizarIndividualView(totais[0]);
            break;
    }
}

function renderizarHomeView(totais, listaBase) {
    homeView.style.display = 'block';
    renderizarRanking(totais);
    renderizarGraficoGeralPizza(totais);
    renderizarGraficoAnualGeral(listaBase);
}

function renderizarIndividualView(entidadeAtiva) {
    if (!entidadeAtiva) return;
    individualView.style.display = 'block';
    
    const infoCard = document.getElementById('info-entidade');
    infoCard.className = 'card info-container';
    if (entidadeAtiva.level > 0) infoCard.classList.add(`level-${entidadeAtiva.level}`);
    
    entidadeNomeEl.textContent = entidadeAtiva.nome;
    entidadeFotoEl.src = entidadeAtiva.foto;
    renderizarCardTotais(entidadeAtiva);
    renderizarCalendario();
    renderizarGraficoAnual(entidadeAtiva);
}

function init() {
    popularSeletores();
    
    homeButton.addEventListener('click', () => {
        isSidebarListVisible = false;
        activeView = 'vereadores';
        entidadeAtivaId = null;
        renderizarViews();
    });
    vereadoresButton.addEventListener('click', () => {
        isSidebarListVisible = true;
        activeView = 'vereadores';
        entidadeAtivaId = null;
        renderizarViews();
    });
    comissoesButton.addEventListener('click', () => {
        isSidebarListVisible = true;
        activeView = 'comissoes';
        entidadeAtivaId = null;
        renderizarViews();
    });
    institucionalButton.addEventListener('click', () => {
        isSidebarListVisible = false;
        activeView = 'institucional';
        entidadeAtivaId = INSTITUCIONAL[0].id;
        renderizarViews();
    });

    searchBar.addEventListener('input', applySearchFilter);
    seletorMes.addEventListener('change', () => { escutarMetaMensal(); });
    seletorAno.addEventListener('change', () => { escutarMetaMensal(); });
   
    escutarMudancasNosDados();
    escutarMetaMensal();
    
    renderizarViews();
}
init();

</script>
</body>
</html>

