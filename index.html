<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - CMM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --cor-primaria: #0d6efd; /* Azul primário */
            --cor-secundaria: #6c757d; /* Cinza secundário */
            --fundo: #f8f9fa; /* Fundo cinza claro */
            --borda: #dee2e6;
            --texto: #212529;
            --branco: #fff;
            --sombra: 0 4px 8px rgba(0, 0, 0, 0.05);
            --marrom-logo: #5D493C;
            --vermelho-inativo: #dc3545;
            --level-1-color: #fd7e14;
            --level-2-color: #ffc107;
            --level-3-color: #a3d900;
            --level-4-color: #198754;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--fundo);
            color: var(--texto);
        }
        #login-view { display: flex; justify-content: center; align-items: center; height: 100vh; }
        #login-box { background: var(--branco); padding: 40px; border-radius: 8px; box-shadow: var(--sombra); text-align: center; width: 90%; max-width: 400px; }
        #login-box img { max-width: 250px; margin-bottom: 20px; }
        #login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--borda); border-radius: 6px; font-size: 1em; box-sizing: border-box; }
        #login-button { width: 100%; padding: 12px; background-color: var(--cor-primaria); color: var(--branco); border: none; border-radius: 6px; font-size: 1.1em; cursor: pointer; }
        #login-error { color: var(--vermelho-inativo); margin-top: 15px; min-height: 1.2em; }

        #dashboard-view { display: none; flex-direction: column; height: 100vh; }
        
        #app-header { display: flex; justify-content: center; align-items: center; padding: 15px 30px; background-color: var(--branco); border-bottom: 1px solid var(--borda); flex-shrink: 0; position: relative; }
        #header-buttons { position: absolute; left: 30px; display: flex; align-items: center; gap: 10px; }
        #app-header h1 { font-size: 2em; color: var(--marrom-logo); margin: 0; }
        #app-header-logo { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); }
        #app-header-logo img { height: 50px; max-width: 250px; display: block; }
        .header-btn { padding: 8px 15px; font-size: 1em; background-color: var(--cor-secundaria); color: var(--branco); border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        .header-btn:hover { opacity: 0.9; }
        
        #app-container { display: flex; flex-grow: 1; overflow: hidden; }
        #sidebar { width: 300px; background-color: var(--branco); border-right: 1px solid var(--borda); padding: 20px; overflow-y: auto; flex-shrink: 0; }
        #sidebar-title { color: var(--cor-primaria); text-align: center; margin-top: 0; margin-bottom: 15px; }
        #lista-entidades { list-style: none; padding: 0; margin: 0; }
        .nav-item { display: flex; align-items: center; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; position: relative; }
        .nav-item:hover { background-color: #e9ecef; }
        .nav-item.active { background-color: var(--cor-primaria); color: var(--branco); font-weight: 600; }
        .entidade-foto-container { position: relative; flex-shrink: 0; }
        .nav-item img { width: 68px; height: 68px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 3px solid #d3d3d3; }
        .inactivity-indicator { display: none; position: absolute; top: 0; right: 15px; width: 18px; height: 18px; background-color: var(--vermelho-inativo); border: 2px solid var(--branco); border-radius: 50%; }
        .nav-item.inactive .inactivity-indicator { display: block; }
        
        #home-button { padding: 0; justify-content: center; }
        #home-button-icon { width: 223px; height: 50px; border-radius: 8px; object-fit: contain; border: 2px solid transparent; background: transparent; margin-right: 0; padding: 5px; box-sizing: border-box; }
        #home-button.active { background-color: transparent; }
        #home-button.active #home-button-icon { filter: none; border: 2px solid var(--marrom-logo); }

        #vereadores-button,
        #comissoes-button,
        #institucional-button { 
            justify-content: center; 
            font-weight: 600; 
            font-size: 1.1em; 
            border: 1px solid var(--borda); 
            background-color: var(--fundo); 
            color: var(--texto); 
        }
        #vereadores-button { margin-top: 15px; }

        #vereadores-button.active,
        #comissoes-button.active,
        #institucional-button.active { 
            background-color: var(--cor-primaria); 
            color: var(--branco); 
            border-color: var(--cor-primaria); 
        }

        #search-bar { width: 100%; padding: 10px; border: 1px solid var(--borda); border-radius: 6px; font-size: 1em; box-sizing: border-box; margin-top: 15px; }

        #main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .header-controles { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px; background-color: rgba(248, 249, 250, 0.9); padding: 15px; border-radius: 8px; box-shadow: var(--sombra); position: sticky; top: -30px; z-index: 10; }
        .card { background-color: var(--branco); border-radius: 8px; padding: 25px; box-shadow: var(--sombra); margin-bottom: 25px; }
        #ranking-card h2, .chart-card h2 { text-align: center; margin-top: 0; }
        .pizza-total-container { text-align: center; font-size: 1.2em; margin-top: 15px; }
        .pizza-total-container strong { font-size: 1.5em; color: var(--cor-primaria); }

        .home-charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .chart-card { height: 450px; }

        .ranking-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 25px 20px; justify-items: center; }
        .podium-item { position: relative; cursor: pointer; }
        .podium-item img { width: 70px; height: 70px; border-radius: 50%; border: 4px solid #d3d3d3; transition: transform 0.2s ease-in-out; object-fit: cover; }
        .podium-item:hover img { transform: scale(1.1); }
        .podium-rank-badge { position: absolute; bottom: 2px; right: 2px; background-color: rgba(0, 0, 0, 0.7); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; font-size: 0.8em; font-weight: bold; }
        .custom-tooltip { visibility: hidden; opacity: 0; position: absolute; top: 105%; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; text-align: left; padding: 10px; border-radius: 6px; z-index: 1; font-size: 1em; white-space: nowrap; transition: opacity 0.3s; }
        .podium-item:hover .custom-tooltip { visibility: visible; opacity: 1; }
        
        .nav-item.level-1 img, .podium-item.level-1 img, #info-entidade.level-1 img { border-color: var(--level-1-color); }
        .nav-item.level-2 img, .podium-item.level-2 img, #info-entidade.level-2 img { border-color: var(--level-2-color); }
        .nav-item.level-3 img, .podium-item.level-3 img, #info-entidade.level-3 img { border-color: var(--level-3-color); }
        .nav-item.level-4 img, .podium-item.level-4 img, #info-entidade.level-4 img { border-color: var(--level-4-color); }
        
        .info-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: center; }
        #info-entidade { display: flex; align-items: center; }
        
        #info-entidade img {
            width: 120px;
            height: 160px;
            border-radius: 8px;
            margin-right: 25px;
            border-width: 4px;
            border-style: solid;
            border-color: #d3d3d3;
            object-fit: cover;
        }
        
        #info-entidade h1 { margin: 0; font-size: 2.2em; }
        
        #totais-card { display: flex; justify-content: space-around; text-align: center; }
        .total-item h3 { margin: 0 0 10px 0; color: var(--cor-secundaria); font-size: 1.1em; }
        .total-valor { font-size: 2.5em; font-weight: bold; color: var(--cor-primaria); }
        
        .individual-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            align-items: start;
        }
        .individual-content-grid > .card {
            height: 420px;
            display: flex;
            flex-direction: column;
        }
        #calendar-container, #graficoAnual {
            flex-grow: 1;
            min-height: 0;
        }

        #calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; color: var(--cor-secundaria); margin-bottom: 10px; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex-grow: 1; }
        .calendar-day { 
            padding: 5px; 
            min-height: 50px;
            background-color: var(--branco); 
            border: 1px solid var(--borda); 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            font-size: 0.75em; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            position: relative; 
        }
        .calendar-day:hover { background-color: #e9ecef; }
        .calendar-day.weekend .day-number { color: #adb5bd; }
        .day-number { font-weight: bold; }
        .day-value { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--cor-primaria); 
            text-align: center; 
        }
        .note-indicator { position: absolute; top: 5px; right: 5px; }
        .link-indicators-container {
            position: absolute;
            top: 5px;
            left: 5px;
            display: flex;
            gap: 4px;
        }
        .link-indicator { 
            color: var(--cor-secundaria); 
            text-decoration: none; 
            font-size: 1.1em;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background-color: var(--branco); padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; width: 90%; max-width: 400px; }
        #modal-title { margin-top: 0; }
        #modal-input { width: 100%; padding: 10px; font-size: 1.2em; margin: 20px 0; box-sizing: border-box; text-align: center; }
        #modal-observation { width: 100%; height: 80px; padding: 10px; font-size: 1em; margin-bottom: 20px; box-sizing: border-box; resize: vertical; }
        .modal-actions button { padding: 10px 20px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; margin: 0 10px; }
        #modal-save-btn { background-color: var(--cor-primaria); color: var(--branco); }
        #modal-cancel-btn { background-color: var(--cor-secundaria); color: var(--branco); }

        #goal-container { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--borda); }
        #goal-input-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; }
        #monthly-goal-input { width: 80px; padding: 5px; text-align: center; font-size: 1.1em; }
        #goal-progress-container { background-color: var(--borda); border-radius: 10px; overflow: hidden; }
        #goal-progress-bar { height: 20px; background-color: var(--level-4-color); width: 0%; transition: width 0.5s; }
        #goal-progress-text { text-align: center; margin-top: 5px; font-weight: 500; }
    </style>
</head>
<body>
    <div id="login-view">
        <div id="login-box">
            <img src="./Logo CMM Horizontal.png" alt="Logo Câmara Municipal de Marabá">
            <input type="email" id="email-input" placeholder="Email">
            <input type="password" id="password-input" placeholder="Senha">
            <button id="login-button">Entrar</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="dashboard-view">
        <header id="app-header">
            <div id="header-buttons">
                <button id="print-button" class="header-btn" title="Imprimir Relatório">🖨️ Imprimir</button>
                <button id="export-csv-button" class="header-btn" title="Exportar para CSV">📄 Exportar</button>
                <button id="logout-button" class="header-btn" title="Terminar Sessão">🔒 Sair</button>
            </div>
            <h1>CÂMARA MUNICIPAL DE MARABÁ</h1>
            <a id="app-header-logo" href="#" target="_blank" rel="noopener noreferrer">
                <img src="./Logo CMM Horizontal.png" alt="Logo Câmara Municipal de Marabá">
            </a>
        </header>

        <div id="app-container">
            <aside id="sidebar">
                <h2 id="sidebar-title">Visão Geral</h2>
                <div id="sidebar-nav-buttons">
                    <div id="home-button" class="nav-item">
                        <img src="./Logo CMM Horizontal.png" id="home-button-icon" alt="Página Inicial">
                    </div>
                    <div id="vereadores-button" class="nav-item">
                         <span>Vereadores</span>
                    </div>
                    <div id="comissoes-button" class="nav-item">
                        <span>Comissões</span>
                    </div>
                    <div id="institucional-button" class="nav-item">
                        <span>Institucional</span>
                    </div>
                </div>
                <div id="sidebar-list-container">
                    <input type="search" id="search-bar" placeholder="Pesquisar...">
                    <ul id="lista-entidades"></ul>
                </div>
            </aside>

            <main id="main-content">
                <div class="header-controles">
                    <label for="seletor-mes">Mês:</label>
                    <select id="seletor-mes"></select>
                    <label for="seletor-ano">Ano:</label>
                    <select id="seletor-ano"></select>
                </div>
                
                <div id="home-view">
                    <div id="ranking-card" class="card">
                        <h2>🏆 Ranking do Mês</h2>
                        <div class="ranking-container" id="ranking-container"></div>
                    </div>
        
                    <div class="home-charts-container">
                        <div class="card chart-card" id="pizza-card-container">
                            <h2 id="titulo-grafico-geral">Matéria Geral do Mês</h2>
                            <canvas id="graficoGeralPizza"></canvas>
                            <div class="pizza-total-container">
                                <p id="pizza-total">Total de Matérias: <strong>0</strong></p>
                            </div>
                             <div id="goal-container">
                                 <div id="goal-input-container">
                                    <label for="monthly-goal-input">Meta do Mês:</label>
                                    <input type="number" id="monthly-goal-input" min="0">
                                </div>
                                  <div id="goal-progress-container">
                                       <div id="goal-progress-bar"></div>
                                  </div>
                                  <p id="goal-progress-text">0 / 0 (0%)</p>
                             </div>
                        </div>
                        <div class="card chart-card">
                            <h2>Desempenho Geral Anual</h2>
                            <canvas id="graficoAnualGeral"></canvas>
                        </div>
                    </div>
                </div>

                <div id="individual-view" style="display: none;">
                    <div class="info-container">
                        <div class="card" id="info-entidade">
                            <img id="entidade-foto" src="" alt="Foto">
                            <div class="info-details">
                                <h1 id="entidade-nome"></h1>
                            </div>
                        </div>
                        <div class="card" id="totais-card">
                            <div class="total-item">
                                <h3>Total no Mês</h3>
                                <p class="total-valor" id="total-mes">0</p>
                            </div>
                            <div class="total-item">
                                <h3>Total no Ano</h3>
                                <p class="total-valor" id="total-ano">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="individual-content-grid">
                        <div class="card">
                            <h2>Lançamento de Matéria Diária</h2>
                            <div id="calendar-container">
                                <div id="calendar-weekdays">
                                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                                </div>
                                <div id="calendar-grid"></div>
                            </div>
                        </div>
            
                        <div class="card">
                            <h2>Desempenho Anual (por Mês)</h2>
                            <canvas id="graficoAnual"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="entry-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Lançar Matéria</h3>
            <p id="modal-date"></p>
            <input type="number" id="modal-input" placeholder="0" min="0">
            <textarea id="modal-observation" placeholder="Adicionar observações ou links..."></textarea>
            <div class="modal-actions">
                <button id="modal-save-btn">Salvar</button>
                <button id="modal-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

<script type="module">
// ===================================================================================
// IMPORTAÇÕES DO FIREBASE E CONFIGURAÇÕES
// ===================================================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBOgVuFwTQgTT8UuRQL-SAFvy_SfFv5Ge0",
    authDomain: "controle-de-materias-a8112.firebaseapp.com",
    projectId: "controle-de-materias-a8112",
    storageBucket: "controle-de-materias-a8112.firebasestorage.app",
    messagingSenderId: "272892661767",
    appId: "1:272892661767:web:26d852120fa614a1b41aa2"
};

// ===================================================================================
// PASSO 1: CONFIGURE OS LINKS DA CÂMARA AQUI
// ===================================================================================
const CMM_LINKS = {
    site: "https://maraba.pa.leg.br/",
    instagram: "https://www.instagram.com/camarademaraba",
    facebook: "https://www.facebook.com/camarademaraba"
};

// ===================================================================================
// PASSO 2: CONFIGURE AS ENTIDADES (VEREADORES, COMISSÕES E INSTITUCIONAL)
// ===================================================================================
const VEREADORES = [
    { id: 'aerton_lima_da_cruz', nome: 'Aerton Lima da Cruz', foto: './aerton.png' },
    { id: 'antonio_marcio_farias_goncalves', nome: 'Antonio Márcio Farias Gonçalves', foto: './marcio.jpg' },
    { id: 'claudean_pereira_guimaraes', nome: 'Claudean Pereira Guimarães', foto: './dean.jpg' },
    { id: 'deodato_do_espirito_santo', nome: 'Deodato do Espirito Santo', foto: './dato.jpg' },
    { id: 'fernando_henrique_pereira_da_silva', nome: 'Fernando Henrique Pereira da Silva', foto: './fernando.jpg' },
    { id: 'ilker_moraes_ferreira', nome: 'Ilker Moraes Ferreira', foto: './ilker.jpg' },
    { id: 'jimmyson_mesquita_pacheco', nome: 'Jimmyson Mesquita Pacheco', foto: './pacheco.jpg' },
    { id: 'jocenilson_silva_souza', nome: 'Jocenilson Silva Souza', foto: './jocenilson.jpg' },
    { id: 'maiana_clara_rodrigues_stringari', nome: 'Maiana Clara Rodrigues Stringari', foto: './maiana.jpg' },
    { id: 'marcelo_alves_dos_santos', nome: 'Marcelo Alves dos Santos', foto: './marcelo.jpg' },
    { id: 'marcos_almeida_sousa_de_andrade', nome: 'Marcos Almeida Sousa de Andrade', foto: './marcos.jpg' },
    { id: 'maria_cristina_coimbra_mutran', nome: 'Maria Cristina Coimbra Mutran', foto: './cristina.jpg' },
    { id: 'miterran_lopes_feitosa', nome: 'Miterran Lopes Feitosa', foto: './miterran.jpg' },
    { id: 'orlando_da_silva_elias', nome: 'Orlando da Silva Elias', foto: './orlando.jpg' },
    { id: 'pedro_correa_lima', nome: 'Pedro Corrêa Lima', foto: './pedro.jpg' },
    { id: 'priscila_duarte_veloso_da_silva', nome: 'Priscila Duarte Veloso da Silva', foto: './priscila.jpg' },
    { id: 'rodrigo_lima_da_silva', nome: 'Rodrigo Lima da Silva', foto: './rodrigo.jpg' },
    { id: 'ronaldo_alves_de_araujo', nome: 'Ronaldo Alves de Araújo', foto: './ronaldo.jpg' },
    { id: 'ronisteu_da_silva_araujo', nome: 'Ronisteu da Silva Araújo', foto: './ronisteu.jpg' },
    { id: 'ubirajara_nazareno_sompre', nome: 'Ubirajara Nazareno Sompré', foto: './ubirajara.jpg' },
    { id: 'vanda_regia_americo_gomes', nome: 'Vanda Régia Américo Gomes', foto: './vanda.jpg' }
];

const COMISSOES = [
    { id: 'comissao_justica_legislacao_redacao', nome: 'Comissão de Justiça, Legislação e Redação', foto: './Comissão  Justiça.png' },
    { id: 'comissao_financas_orcamento', nome: 'Comissão de Finanças e Orçamento', foto: './Comissão  Finanças e Orçamento_.png' },
    { id: 'comissao_desenvolvimento_urbano', nome: 'Comissão de Desenvolvimento Urbano, Obras, Serviços Públicos e Transportes', foto: './Desenvolvimento Urbano.png' },
    { id: 'comissao_administracao_saude', nome: 'Comissão de Administração, Saúde, Serviços e Segurança Pública e Seguridade Social', foto: './Administração.png' },
    { id: 'comissao_educacao_cultura_desporto', nome: 'Comissão de Educação, Cultura e Desporto', foto: './Comissão de Educação.png' },
    { id: 'comissao_direitos_humanos', nome: 'Comissão de Direitos Humanos, Defesa do Consumidor, da Infância e Juventude, da Mulher e do Idoso', foto: './Direitos Humanos.png' },
    { id: 'comissao_mineracao_energia', nome: 'Comissão de Mineração, Energia, Meio Ambiente, Trabalho, Indústria, Comércio e Economia', foto: './Comissão de Mineração.png' }
];

const INSTITUCIONAL = [
    { id: 'institucional_cmm', nome: 'Institucional CMM', foto: './Câmara Municipal de Marabá .jpg' }
];

// ===================================================================================
// LÓGICA DO DASHBOARD
// ===================================================================================
Chart.register(ChartDataLabels);

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Elementos da UI
const loginView = document.getElementById('login-view');
const dashboardView = document.getElementById('dashboard-view');
const loginButton = document.getElementById('login-button');
const logoutButton = document.getElementById('logout-button');
const emailInput = document.getElementById('email-input');
const passwordInput = document.getElementById('password-input');
const loginError = document.getElementById('login-error');
const seletorMes = document.getElementById('seletor-mes');
const seletorAno = document.getElementById('seletor-ano');
const listaEntidadesEl = document.getElementById('lista-entidades');
const entidadeNomeEl = document.getElementById('entidade-nome');
const entidadeFotoEl = document.getElementById('entidade-foto');
const entryModal = document.getElementById('entry-modal');
const modalDateEl = document.getElementById('modal-date');
const modalInputEl = document.getElementById('modal-input');
const modalObservationEl = document.getElementById('modal-observation');
const homeView = document.getElementById('home-view');
const individualView = document.getElementById('individual-view');
const homeButton = document.getElementById('home-button');
const vereadoresButton = document.getElementById('vereadores-button');
const comissoesButton = document.getElementById('comissoes-button');
const institucionalButton = document.getElementById('institucional-button');
const searchBar = document.getElementById('search-bar');
const monthlyGoalInput = document.getElementById('monthly-goal-input');
const sidebarTitleEl = document.getElementById('sidebar-title');
const sidebarListContainer = document.getElementById('sidebar-list-container');

// Estado da Aplicação
let currentUserRole = null;
let dadosProducao = {};
let metaMensal = 0;
let activeView = 'vereadores';
let entidadeAtivaId = null; 
let isSidebarListVisible = false;
let chartGeralInstance, chartAnualInstance, chartAnualGeralInstance;
let isInitialized = false;
const MESES = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

// Lógica de autenticação
onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userRoleDoc = await getDoc(doc(db, "users", user.uid));
        currentUserRole = userRoleDoc.exists() ? userRoleDoc.data().role : 'user';
        loginView.style.display = 'none';
        dashboardView.style.display = 'flex';
        initDashboard();
    } else {
        isInitialized = false;
        currentUserRole = null;
        loginView.style.display = 'flex';
        dashboardView.style.display = 'none';
    }
});

loginButton.addEventListener('click', () => {
    const email = emailInput.value;
    const password = passwordInput.value;
    loginError.textContent = '';
    signInWithEmailAndPassword(auth, email, password)
        .catch(error => { loginError.textContent = 'Email ou senha inválidos.'; });
});

logoutButton.addEventListener('click', () => { signOut(auth); });

function isUrl(text) {
    if (typeof text !== 'string') return false;
    const urlRegex = /^(https?:\/\/)/i;
    return urlRegex.test(text.trim());
}

function extractUrls(text) {
    if (typeof text !== 'string') return [];
    const words = text.split(/\s+/);
    return words.filter(word => isUrl(word));
}

function getProductionLevel(totalMensal) {
    if (totalMensal === 0) return 0;
    if (totalMensal <= 2) return 1;
    if (totalMensal <= 4) return 2;
    if (totalMensal <= 5) return 3;
    if (totalMensal >= 6) return 4;
    return 0;
}

function calcularTotais(ano, mes, listaDeEntidades) {
    let anoAnterior = ano;
    let mesAnterior = mes - 1;
    if (mesAnterior < 0) { mesAnterior = 11; anoAnterior = ano - 1; }

    return listaDeEntidades.map(entidade => {
        let totalMensal = 0, totalAnual = 0, totalMesAnterior = 0;
        const diasNoMes = new Date(ano, mes + 1, 0).getDate();
        for (let dia = 1; dia <= diasNoMes; dia++) {
            const chave = `${entidade.id}_${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            if (dadosProducao[chave]) totalMensal += (dadosProducao[chave].quantidade || 0);
        }
        for (const chave in dadosProducao) {
            if (chave.startsWith(`${entidade.id}_${ano}`)) totalAnual += (dadosProducao[chave].quantidade || 0);
        }
        const diasNoMesAnterior = new Date(anoAnterior, mesAnterior + 1, 0).getDate();
        for (let dia = 1; dia <= diasNoMesAnterior; dia++) {
            const chave = `${entidade.id}_${anoAnterior}-${String(mesAnterior + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            if (dadosProducao[chave]) totalMesAnterior += (dadosProducao[chave].quantidade || 0);
        }
        const level = getProductionLevel(totalMensal);
        return { ...entidade, totalMensal, totalAnual, totalMesAnterior, level };
    });
}

function escutarMudancasNosDados() {
    onSnapshot(collection(db, "materia"), (snapshot) => {
        dadosProducao = {};
        snapshot.forEach(doc => { dadosProducao[doc.id] = doc.data(); });
        renderizarViews();
    });
}

async function escutarMetaMensal() {
    const ano = seletorAno.value;
    const mes = String(parseInt(seletorMes.value) + 1).padStart(2, '0');
    const metaDocRef = doc(db, "metas", `${ano}-${mes}`);
    const docSnap = await getDoc(metaDocRef);
    metaMensal = docSnap.exists() ? docSnap.data().valor : 0;
    monthlyGoalInput.value = metaMensal;
    renderizarViews();
}

async function salvarMetaMensal() {
    const ano = seletorAno.value;
    const mes = String(parseInt(seletorMes.value) + 1).padStart(2, '0');
    const metaDocRef = doc(db, "metas", `${ano}-${mes}`);
    const novoValor = parseInt(monthlyGoalInput.value) || 0;
    await setDoc(metaDocRef, { valor: novoValor });
    metaMensal = novoValor;
    renderizarViews();
}

function abrirModal(dataISO) {
    const chave = `${entidadeAtivaId}_${dataISO}`;
    const dadosDoDia = dadosProducao[chave];
    
    if (currentUserRole === 'user' && dadosDoDia) {
        alert('Acesso negado. Você não pode alterar um lançamento existente.');
        return;
    }

    entryModal.dataset.date = dataISO;
    const [ano, mes, dia] = dataISO.split('-');
    modalDateEl.textContent = `${dia}/${mes}/${ano}`;
    modalInputEl.value = dadosDoDia?.quantidade || '';
    modalObservationEl.value = dadosDoDia?.observacao || '';
    entryModal.classList.add('visible');
    modalInputEl.focus();
}

function fecharModal() { entryModal.classList.remove('visible'); }

async function salvarProducaoModal() {
    const dataISO = entryModal.dataset.date;
    const chave = `${entidadeAtivaId}_${dataISO}`;
    const valor = modalInputEl.value;
    const observacao = modalObservationEl.value;
    const docRef = doc(db, "materia", chave);

    if (valor && !isNaN(parseFloat(valor)) && parseFloat(valor) >= 0) {
        await setDoc(docRef, { quantidade: parseFloat(valor), observacao: observacao });
    } else if (valor === '' && observacao) {
        await setDoc(docRef, { quantidade: 0, observacao: observacao });
    } else if (valor === '' && !observacao) {
        await deleteDoc(docRef);
    } else { alert('Por favor, insira um número válido para a quantidade.'); }
    fecharModal();
}

function popularSeletores() {
    if(seletorMes.options.length > 1) return;
    MESES.forEach((mes, index) => seletorMes.add(new Option(mes, index)));
    seletorMes.value = new Date().getMonth();
    for (let i = 2025; i <= 2034; i++) seletorAno.add(new Option(i, i));
    seletorAno.value = 2025;
}

function applySearchFilter() {
    const searchTerm = searchBar.value.toLowerCase();
    document.querySelectorAll('.entidade-item').forEach(item => {
        const itemName = item.querySelector('span').textContent.toLowerCase();
        item.style.display = itemName.includes(searchTerm) ? 'flex' : 'none';
    });
}

function popularListaSidebar(listaOrdenada) {
    listaEntidadesEl.innerHTML = '';
    listaOrdenada.forEach(entidade => {
        const li = document.createElement('li');
        li.className = 'nav-item entidade-item';
        
        if(entidade.level === 0) li.classList.add('inactive');
        else li.classList.add(`level-${entidade.level}`);
        
        li.dataset.id = entidade.id;
        li.innerHTML = `<div class="entidade-foto-container"><img src="${entidade.foto}" alt="${entidade.nome}"><div class="inactivity-indicator"></div></div><span>${entidade.nome}</span>`;
        if (entidade.id === entidadeAtivaId) li.classList.add('active');
        li.addEventListener('click', () => { 
            entidadeAtivaId = entidade.id; 
            renderizarViews(); 
        });
        listaEntidadesEl.appendChild(li);
    });
    applySearchFilter();
}

function renderizarCalendario() {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    const ano = parseInt(seletorAno.value);
    const mes = parseInt(seletorMes.value);
    const primeiroDia = new Date(ano, mes, 1).getDay();
    const diasNoMes = new Date(ano, mes + 1, 0).getDate();

    for (let i = 0; i < primeiroDia; i++) grid.appendChild(document.createElement('div'));

    for (let dia = 1; dia <= diasNoMes; dia++) {
        const dataISO = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        
        const chave = `${entidadeAtivaId}_${dataISO}`;
        const dadosDoDia = dadosProducao[chave];
        const valorSalvo = dadosDoDia?.quantidade || 0;
        const temObservacao = dadosDoDia?.observacao;
        const urls = extractUrls(temObservacao);

        let content = `<span class="day-number">${dia}</span>`;
        
        if (urls.length > 0) {
            const linksHTML = urls.map(url => 
                `<a href="${url}" target="_blank" class="link-indicator" title="${url}">🔗</a>`
            ).join('');
            content += `<div class="link-indicators-container" title="${temObservacao}">${linksHTML}</div>`;
        } else if (temObservacao) {
            content += `<div class="note-indicator" title="${temObservacao}"></div>`;
        }
        
        content += `<span class="day-value">${valorSalvo > 0 ? valorSalvo : ''}</span>`;
        dayCell.innerHTML = content;
        
        dayCell.addEventListener('click', (e) => {
            if (e.target.closest('.link-indicator')) {
                 return;
            }
            abrirModal(dataISO);
        });
        if (new Date(ano, mes, dia).getDay() % 6 === 0) dayCell.classList.add('weekend');
        grid.appendChild(dayCell);
    }
}

function renderizarRanking(totais) {
    const container = document.getElementById('ranking-container');
    container.innerHTML = '';
    const ranking = [...totais].sort((a, b) => b.totalMensal - a.totalMensal);
    
    ranking.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'podium-item';
        if(item.level > 0) div.classList.add(`level-${item.level}`);
        div.innerHTML = `
            <img src="${item.foto}" alt="${item.nome}">
            <span class="podium-rank-badge">${index + 1}.</span>
            <span class="custom-tooltip">${item.nome} | Atual: ${item.totalMensal} | Anterior: ${item.totalMesAnterior}</span>
        `;
        div.addEventListener('click', () => {
            isSidebarListVisible = true;
            entidadeAtivaId = item.id;
            renderizarViews();
        });
        container.appendChild(div);
    });
}

function renderizarProgressoMeta(totalGeral) {
    const progressBar = document.getElementById('goal-progress-bar');
    const progressText = document.getElementById('goal-progress-text');
    if(metaMensal > 0) {
        const percentual = Math.min((totalGeral / metaMensal) * 100, 100);
        progressBar.style.width = `${percentual}%`;
        progressText.textContent = `${totalGeral} / ${metaMensal} (${percentual.toFixed(0)}%)`;
    } else {
        progressBar.style.width = '0%';
        progressText.textContent = `${totalGeral} / 0 (0%)`;
    }
}

function renderizarGraficoGeralPizza(totais) {
    const ano = parseInt(seletorAno.value), mes = parseInt(seletorMes.value);
    document.getElementById('titulo-grafico-geral').textContent = `Matéria Geral em ${MESES[mes]} de ${ano}`;
    const produtivos = totais.filter(c => c.totalMensal > 0);
    const labels = produtivos.map(c => c.nome);
    const data = produtivos.map(c => c.totalMensal);
    const totalGeral = totais.reduce((sum, value) => sum + value.totalMensal, 0);
    document.querySelector("#pizza-total strong").textContent = totalGeral;
    renderizarProgressoMeta(totalGeral);
    const ctx = document.getElementById('graficoGeralPizza').getContext('2d');
    if (chartGeralInstance) chartGeralInstance.destroy();
    const bgColors = ['#0d6efd', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0', '#adb5bd', '#6c757d', '#343a40', '#007bff', '#6610f2', '#e83e8c', '#c82333', '#e0a800', '#218838', '#17a2b8', '#5a6268', '#23272b'].slice(0, labels.length);
    chartGeralInstance = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: bgColors, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, datalabels: { formatter: (v) => v, color: '#fff', font: { weight: 'bold', size: 14 } } } } });
}

function renderizarGraficoAnualGeral(totais) {
    const ano = parseInt(seletorAno.value);
    const data = [];
    for (let mes = 0; mes < 12; mes++) {
        let totalMesGeral = 0;
        totais.forEach(ent => {
            for (const chave in dadosProducao) {
                 if (chave.startsWith(`${ent.id}_${ano}-${String(mes + 1).padStart(2, '0')}`)) {
                    totalMesGeral += (dadosProducao[chave].quantidade || 0);
                }
            }
        });
        data.push(totalMesGeral);
    }
    const ctx = document.getElementById('graficoAnualGeral').getContext('2d');
    if (chartAnualGeralInstance) chartAnualGeralInstance.destroy();
    chartAnualGeralInstance = new Chart(ctx, { type: 'bar', data: { labels: MESES, datasets: [{ label: `Total de Matérias em ${ano}`, data, backgroundColor: 'rgba(108, 117, 125, 0.7)' }] }, options: { responsive: true, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (v) => v > 0 ? v : '', color: '#333' } } } });
}

function exportarParaCSV() {
    const ano = seletorAno.value;
    const mes = parseInt(seletorMes.value);
    const listaAtiva = activeView === 'vereadores' ? VEREADORES : COMISSOES;
    const nomeArquivo = `relatorio_${activeView}_${MESES[mes]}_${ano}.csv`;
    let csvContent = `data:text/csv;charset=utf-8,Data,${activeView === 'vereadores' ? 'Vereador' : 'Comissão'},Quantidade,Observação\n`;

    for (const chave in dadosProducao) {
        const [id, data] = chave.split(/_(.*)/s);
        if (data && data.startsWith(`${ano}-${String(mes + 1).padStart(2, '0')}`)) {
            const entidade = listaAtiva.find(c => c.id === id);
            if (entidade) {
                const [anoCsv, mesCsv, diaCsv] = data.split('-');
                const dataFormatada = `${diaCsv}/${mesCsv}/${anoCsv}`;
                const quantidade = dadosProducao[chave].quantidade || 0;
                const observacao = dadosProducao[chave].observacao ? `"${dadosProducao[chave].observacao.replace(/"/g, '""')}"` : '';
                csvContent += `${dataFormatada},"${entidade.nome}",${quantidade},${observacao}\n`;
            }
        }
    }

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", nomeArquivo);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function renderizarCardTotais(dadosEntidade) {
    document.getElementById('total-mes').textContent = dadosEntidade.totalMensal;
    document.getElementById('total-ano').textContent = dadosEntidade.totalAnual;
}

function renderizarGraficoAnual(dadosEntidade) {
    const ano = parseInt(seletorAno.value), data = [];
    for (let mes = 0; mes < 12; mes++) {
        let totalMes = 0;
        for (const chave in dadosProducao) {
            if (chave.startsWith(`${dadosEntidade.id}_${ano}-${String(mes + 1).padStart(2, '0')}`)) {
                totalMes += (dadosProducao[chave].quantidade || 0);
            }
        }
        data.push(totalMes);
    }
    const ctx = document.getElementById('graficoAnual').getContext('2d');
    if (chartAnualInstance) chartAnualInstance.destroy();
    chartAnualInstance = new Chart(ctx, { type: 'bar', data: { labels: MESES, datasets: [{ label: `Total de Matérias em ${ano}`, data, backgroundColor: 'rgba(25, 135, 84, 0.7)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (v) => v > 0 ? v : '', color: '#333' } } } });
}

function updateUIPermissions() {
    monthlyGoalInput.disabled = (currentUserRole !== 'admin');
}

function renderizarViews() {
    const ano = parseInt(seletorAno.value);
    const mes = parseInt(seletorMes.value);
    
    sidebarListContainer.style.display = isSidebarListVisible ? 'block' : 'none';

    homeButton.classList.remove('active');
    vereadoresButton.classList.remove('active');
    comissoesButton.classList.remove('active');
    institucionalButton.classList.remove('active');
    
    if (!isSidebarListVisible && activeView !== 'institucional') {
        homeButton.classList.add('active');
        sidebarTitleEl.textContent = 'Visão Geral';
    } else if (activeView === 'vereadores') {
        vereadoresButton.classList.add('active');
    } else if (activeView === 'comissoes') {
        comissoesButton.classList.add('active');
    } else if (activeView === 'institucional') {
        institucionalButton.classList.add('active');
    }

    homeView.style.display = 'none';
    individualView.style.display = 'none';
    let totais;

    switch (activeView) {
        case 'vereadores':
            if (isSidebarListVisible) sidebarTitleEl.textContent = 'Vereadores';
            searchBar.placeholder = 'Pesquisar vereador...';
            totais = calcularTotais(ano, mes, VEREADORES);
            
            totais.sort((a, b) => a.totalMensal - b.totalMensal);
            popularListaSidebar(totais);

            if (entidadeAtivaId) {
                renderizarIndividualView(totais.find(c => c.id === entidadeAtivaId));
            } else {
                renderizarHomeView(totais);
            }
            break;

        case 'comissoes':
            if (isSidebarListVisible) sidebarTitleEl.textContent = 'Comissões';
            searchBar.placeholder = 'Pesquisar comissão...';
            totais = calcularTotais(ano, mes, COMISSOES);
            
            totais.sort((a, b) => a.totalMensal - b.totalMensal);
            popularListaSidebar(totais);

            if (entidadeAtivaId) {
                renderizarIndividualView(totais.find(c => c.id === entidadeAtivaId));
            } else {
                renderizarHomeView(totais);
            }
            break;

        case 'institucional':
            sidebarTitleEl.textContent = 'Institucional';
            totais = calcularTotais(ano, mes, INSTITUCIONAL);
            renderizarIndividualView(totais[0]);
            break;
    }
    updateUIPermissions();
}

function renderizarHomeView(totais) {
    homeView.style.display = 'block';
    renderizarRanking(totais);
    renderizarGraficoGeralPizza(totais);
    renderizarGraficoAnualGeral(totais);
}

function renderizarIndividualView(entidadeAtiva) {
    if (!entidadeAtiva) return;
    individualView.style.display = 'block';
    
    const infoCard = document.getElementById('info-entidade');
    infoCard.className = 'card info-container';
    if (entidadeAtiva.level > 0) infoCard.classList.add(`level-${entidadeAtiva.level}`);
    
    entidadeNomeEl.textContent = entidadeAtiva.nome;
    entidadeFotoEl.src = entidadeAtiva.foto;
    renderizarCardTotais(entidadeAtiva);
    renderizarCalendario();
    renderizarGraficoAnual(entidadeAtiva);
}

function initDashboard() {
    if (isInitialized) {
        renderizarViews();
        return;
    }
    
    popularSeletores();
    
    homeButton.addEventListener('click', () => {
        isSidebarListVisible = false;
        activeView = 'vereadores';
        entidadeAtivaId = null;
        renderizarViews();
    });
    vereadoresButton.addEventListener('click', () => {
        isSidebarListVisible = true;
        activeView = 'vereadores';
        entidadeAtivaId = null;
        renderizarViews();
    });
    comissoesButton.addEventListener('click', () => {
        isSidebarListVisible = true;
        activeView = 'comissoes';
        entidadeAtivaId = null;
        renderizarViews();
    });
    institucionalButton.addEventListener('click', () => {
        isSidebarListVisible = false;
        activeView = 'institucional';
        entidadeAtivaId = INSTITUCIONAL[0].id;
        renderizarViews();
    });

    searchBar.addEventListener('input', applySearchFilter);
    seletorMes.addEventListener('change', () => { escutarMetaMensal(); });
    seletorAno.addEventListener('change', () => { escutarMetaMensal(); });
    document.getElementById('print-button').addEventListener('click', () => {
        if (!entidadeAtivaId) {
            alert("Por favor, selecione um perfil para imprimir o relatório.");
            return;
        }
        window.print();
    });
    document.getElementById('export-csv-button').addEventListener('click', exportarParaCSV);
    document.getElementById('modal-save-btn').addEventListener('click', salvarProducaoModal);
    document.getElementById('modal-cancel-btn').addEventListener('click', fecharModal);
    entryModal.addEventListener('click', (e) => { if (e.target === entryModal) fecharModal(); });
    monthlyGoalInput.addEventListener('change', salvarMetaMensal);

    escutarMudancasNosDados();
    escutarMetaMensal();
    
    renderizarViews();

    isInitialized = true;
}

</script>
</body>
</html>
